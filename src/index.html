<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultrasonic Scanner Interface</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        
        .control-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-row {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .control-group label {
            font-weight: bold;
            min-width: 120px;
        }
        
        select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            min-width: 200px;
        }
        
        select:disabled {
            background-color: #f5f5f5;
            color: #999;
        }
        
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            min-width: 80px;
        }
        
        button:enabled {
            background-color: #007bff;
            color: white;
        }
        
        button:enabled:hover {
            background-color: #0056b3;
        }
        
        button:disabled {
            background-color: #6c757d;
            color: #fff;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .trigger-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .mode-selection {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .mode-selection input[type="radio"] {
            margin-right: 5px;
        }
        
        .run-stop-btn {
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            min-width: 100px;
        }
        
        .run-stop-btn.running {
            background-color: #dc3545;
        }
        
        .run-stop-btn.running:hover {
            background-color: #c82333;
        }
        
        .run-stop-btn.stopped {
            background-color: #28a745;
        }
        
        .run-stop-btn.stopped:hover {
            background-color: #218838;
        }
        
        .status {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            min-height: 20px;
        }
        
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
        
        .status.connecting {
            background-color: #fff3cd;
            color: #856404;
            border-color: #ffeaa7;
        }
        
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
        
        .scan-display {
            margin-top: 30px;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
        }
        
        .scan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .scan-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }
        
        .info-label {
            font-weight: bold;
        }
        
        .scan-result {
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-top: 15px;
        }
        
        .scan-result.good {
            background-color: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .scan-result.bad {
            background-color: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .scan-result.waiting {
            background-color: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .info {
            margin-top: 20px;
            padding: 15px;
            background-color: #e7f3ff;
            border: 1px solid #b3d7ff;
            border-radius: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>Ultrasonic Scanner Interface</h1>
    
    <div class="control-section">
        <!-- Serial Port Controls -->
        <div class="control-row">
            <div class="control-group">
                <label>Serial Port:</label>
                <select id="portSelect">
                    <option value="">Scanning for ports...</option>
                </select>
            </div>
            <button id="connectButton" disabled>Connect</button>
            <button id="disconnectButton" disabled>Disconnect</button>
        </div>
        
        <!-- Single Mode Controls (Auto mode temporarily disabled) -->
        <div class="control-row">
            <div class="control-group">
                <label>Mode: Single Trigger</label>
                <button id="runStopButton" class="run-stop-btn stopped" disabled>RUN</button>
            </div>
        </div>
    </div>
    
    <div id="connectionStatus" class="status disconnected">No connection</div>
    
    <!-- Scan Display Area -->
    <div class="scan-display">
        <div class="scan-header">
            <h2>Scan Results</h2>
            <div id="scanCounter">Scans Received: 0</div>
        </div>
        
        <div class="scan-info">
            <div class="info-item">
                <span class="info-label">Boot ID:</span>
                <span id="bootId">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Scan ID:</span>
                <span id="scanId">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Scan Name:</span>
                <span id="scanName">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Angles:</span>
                <span id="numAngles">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">Data Packets:</span>
                <span id="dataPacketCount">0</span>
            </div>
            <div class="info-item">
                <span class="info-label">Expected Packets:</span>
                <span id="expectedPackets">-</span>
            </div>
        </div>
        
        <div class="progress-bar">
            <div id="progressFill" class="progress-fill" style="width: 0%">0%</div>
        </div>
        
        <div id="scanResult" class="scan-result waiting">
            Waiting for scan data...
        </div>

        <!-- ADD THESE MISSING ELEMENTS: -->
        
        <!-- Scan Configuration Display -->
        <div id="scanConfigDisplay" class="scan-config-display" style="display: none;">
            <h4>Scan Configuration</h4>
            <div id="scanConfigText">No scan data available</div>
        </div>
        
        <!-- Chart Controls -->
        <div id="chartControlsContainer" class="chart-controls" style="display: none;">
            <div class="control-group">
                <label>Angle:</label>
                <select id="angleSelect">
                    <option value="0">Angle 0</option>
                </select>
            </div>
            <div class="control-group">
                <label>Step:</label>
                <select id="stepSelect">
                    <option value="0">Step 0</option>
                </select>
            </div>
            <button id="updateChartButton">Update Chart</button>
        </div>
        
        <!-- ECharts Container (THIS IS THE MISSING ONE) -->
        <div id="chartContainer" class="chart-container" style="display: none;"></div>        
    </div>
    
    <div class="info">
        <strong>Instructions:</strong>
        <ul>
            <li><strong>Auto Mode:</strong> Continuously processes scans. Display updates automatically when each scan completes.</li>
            <li><strong>Single Mode:</strong> Captures one scan, displays result, then stops. Click RUN to trigger next scan.</li>
            <li>Connect to your ultrasonic scanner device first, then select trigger mode.</li>
            <li>Green = Scan Complete, Red = Scan Failed/Incomplete, Yellow = In Progress</li>
        </ul>
    </div>

    <script>
        // This will be replaced with the integrated JavaScript
        console.log('Ultrasonic Scanner Interface loaded');
        /*
        
        // Placeholder for the integrated SerialPortManager and UltrasonicDataParser
        class UltrasonicScannerInterface {
            constructor() {
                this.serialManager = null;
                this.dataParser = null;
                this.triggerMode = 'auto';
                this.isRunning = false;
                this.scanCount = 0;
                this.currentScanData = null;
                
                this.initializeUI();
            }
            
            initializeUI() {
                // Initialize trigger mode controls
                const modeRadios = document.querySelectorAll('input[name="triggerMode"]');
                modeRadios.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        this.triggerMode = e.target.value;
                        this.updateTriggerControls();
                    });
                });
                
                // Run/Stop button
                const runStopBtn = document.getElementById('runStopButton');
                runStopBtn.addEventListener('click', () => {
                    this.toggleRunStop();
                });
                
                this.updateTriggerControls();
                this.updateScanDisplay();
            }
            
            updateTriggerControls() {
                const runStopBtn = document.getElementById('runStopButton');
                
                if (this.triggerMode === 'auto') {
                    // In auto mode, always running when connected
                    runStopBtn.style.display = 'none';
                } else {
                    // In single mode, show run/stop button
                    runStopBtn.style.display = 'block';
                    this.updateRunStopButton();
                }
            }
            
            updateRunStopButton() {
                const runStopBtn = document.getElementById('runStopButton');
                
                if (this.isRunning) {
                    runStopBtn.textContent = 'STOP';
                    runStopBtn.className = 'run-stop-btn running';
                } else {
                    runStopBtn.textContent = 'RUN';
                    runStopBtn.className = 'run-stop-btn stopped';
                }
            }
            
            toggleRunStop() {
                if (this.triggerMode === 'single') {
                    this.isRunning = !this.isRunning;
                    this.updateRunStopButton();
                    
                    if (this.isRunning) {
                        this.startSingleCapture();
                    } else {
                        this.stopCapture();
                    }
                }
            }
            
            startSingleCapture() {
                // Reset for new capture
                this.currentScanData = null;
                this.updateScanDisplay('waiting', 'Waiting for scan data...');
            }
            
            stopCapture() {
                // Implementation for stopping capture
                this.updateScanDisplay('bad', 'Capture stopped by user');
            }
            
            updateScanDisplay(status = null, message = null) {
                const scanResult = document.getElementById('scanResult');
                const bootIdEl = document.getElementById('bootId');
                const scanIdEl = document.getElementById('scanId');
                const scanNameEl = document.getElementById('scanName');
                const numAnglesEl = document.getElementById('numAngles');
                const dataPacketCountEl = document.getElementById('dataPacketCount');
                const expectedPacketsEl = document.getElementById('expectedPackets');
                const progressFill = document.getElementById('progressFill');
                const scanCounter = document.getElementById('scanCounter');
                
                // Update scan counter
                scanCounter.textContent = `Scans Received: ${this.scanCount}`;
                
                if (this.currentScanData) {
                    const scan = this.currentScanData;
                    const metadata = scan.metadata;
                    
                    bootIdEl.textContent = `0x${scan.bootId.toString(16).toUpperCase()}`;
                    scanIdEl.textContent = scan.scanId;
                    scanNameEl.textContent = metadata.scanConfig.name || '-';
                    numAnglesEl.textContent = metadata.scanConfig.numAngles || '-';
                    dataPacketCountEl.textContent = scan.dataPackets.size;
                    
                    const expected = metadata.scanConfig.numAngles * 64 * 64;
                    expectedPacketsEl.textContent = expected;
                    
                    // Update progress
                    const progress = expected > 0 ? (scan.dataPackets.size / expected) * 100 : 0;
                    progressFill.style.width = `${progress}%`;
                    progressFill.textContent = `${Math.round(progress)}%`;
                    
                } else {
                    // Clear display
                    bootIdEl.textContent = '-';
                    scanIdEl.textContent = '-';
                    scanNameEl.textContent = '-';
                    numAnglesEl.textContent = '-';
                    dataPacketCountEl.textContent = '0';
                    expectedPacketsEl.textContent = '-';
                    progressFill.style.width = '0%';
                    progressFill.textContent = '0%';
                }
                
                // Update result status
                if (status && message) {
                    scanResult.className = `scan-result ${status}`;
                    scanResult.textContent = message;
                }
            }
            
            // These would be called by the actual parser
            onMetadataReceived(metadata) {
                console.log('Metadata received:', metadata);
                
                // Start new scan tracking
                this.currentScanData = {
                    bootId: metadata.bootId,
                    scanId: metadata.scanId,
                    metadata: metadata,
                    dataPackets: new Map(),
                    isComplete: false,
                    timestamp: Date.now()
                };
                
                this.updateScanDisplay('waiting', 'Receiving scan data...');
            }
            
            onDataPacketReceived(packet) {
                if (this.currentScanData && 
                    packet.bootId === this.currentScanData.bootId && 
                    packet.scanId === this.currentScanData.scanId) {
                    
                    const dataKey = `${packet.angleIndex}_${packet.stepIndex}_${packet.channelIndex}`;
                    this.currentScanData.dataPackets.set(dataKey, packet);
                    
                    // Update display
                    this.updateScanDisplay();
                }
            }
            
            onScanComplete(scan) {
                console.log('Scan complete:', scan);
                this.scanCount++;
                this.currentScanData = scan;
                
                this.updateScanDisplay('good', 'SCAN COMPLETE âœ“');
                
                // Handle trigger modes
                if (this.triggerMode === 'single') {
                    // Stop after completing one scan
                    this.isRunning = false;
                    this.updateRunStopButton();
                }
                // In auto mode, just continue to next scan
            }
            
            onParseError(error, data) {
                console.error('Parse error:', error);
                this.updateScanDisplay('bad', `Parse Error: ${error}`);
            }
        }
        
        // Initialize the interface
        document.addEventListener('DOMContentLoaded', () => {
            if ('serial' in navigator) {
                window.scannerInterface = new UltrasonicScannerInterface();
            } else {
                const status = document.getElementById('connectionStatus');
                if (status) {
                    status.textContent = 'Web Serial API is not supported in this browser';
                    status.className = 'status error';
                }
            }
        }); */
    </script>
</body>
</html>
